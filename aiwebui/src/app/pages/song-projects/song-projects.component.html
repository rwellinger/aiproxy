<div class="song-projects-container master-detail-layout">
  <!-- Left Side: Project List -->
  <div class="list-section">
    <mat-card class="list-card">
      <!-- List Header -->
      <div class="list-header">
        <div class="header-title">
          <div class="header-title-group">
            <h2>
              <i class="fas fa-folder-open"></i>
              {{ 'songProjects.list.title' | translate }}
            </h2>
            <div class="projects-count-badge" *ngIf="totalProjects > 0">
              {{ totalProjects }}
            </div>
          </div>
          <p class="subtitle">{{ 'songProjects.list.subtitle' | translate }}</p>
        </div>
        <button
          type="button"
          class="new-project-button"
          (click)="createNewProject()"
          [matTooltip]="'songProjects.list.actions.new' | translate"
        >
          <i class="fas fa-plus"></i>
        </button>
      </div>

      <!-- Search -->
      <div class="filters-section">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>{{ 'songProjects.list.search' | translate }}</mat-label>
          <input
            matInput
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange($event)"
            [placeholder]="'songProjects.list.search' | translate"
          />
          <i class="fas fa-search" matPrefix></i>
        </mat-form-field>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>{{ 'songProjects.list.loading' | translate }}</p>
      </div>

      <!-- Project List -->
      <div *ngIf="!isLoading" class="projects-list">
        <!-- Empty State -->
        <div *ngIf="projectList.length === 0" class="empty-state">
          <i class="fas fa-folder-open"></i>
          <p>{{ 'songProjects.list.empty' | translate }}</p>
        </div>

        <!-- Project Items -->
        <div
          *ngFor="let project of projectList"
          class="project-item"
          [class.selected]="selectedProject?.id === project.id"
          (click)="selectProject(project)"
        >
          <div class="project-item__header">
            <div class="icon">
              <i class="fas fa-folder"></i>
            </div>
            <div class="title-group">
              <h4>{{ project.project_name }}</h4>
              <span class="sync-badge" [ngClass]="getSyncStatusClass(project.sync_status)">
                {{ 'songProjects.syncStatus.' + project.sync_status | translate }}
              </span>
            </div>
          </div>

          <div class="project-item__tags" *ngIf="project.tags && project.tags.length > 0">
            <mat-chip-set>
              <mat-chip *ngFor="let tag of project.tags">{{ tag }}</mat-chip>
            </mat-chip-set>
          </div>

          <div class="project-item__footer">
            <span class="date">{{ project.updated_at | date:'short' }}</span>
          </div>
        </div>
      </div>

      <!-- Load More Button -->
      <div *ngIf="pagination.has_more && !isLoading" class="load-more-section">
        <button type="button" class="load-more-button" (click)="loadMore()">
          <span>{{ 'common.loadMore' | translate }}</span>
        </button>
      </div>
    </mat-card>
  </div>

  <!-- Right Side: Project Detail -->
  <div class="detail-section">
    <mat-card class="detail-card">
      <!-- Detail Loading State -->
      <div *ngIf="isLoadingDetail" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>{{ 'songProjects.editor.loading' | translate }}</p>
      </div>

      <!-- No Selection State -->
      <div *ngIf="!selectedProject && !isLoadingDetail" class="empty-state">
        <i class="fas fa-folder-open"></i>
        <p>{{ 'songProjects.list.selectPrompt' | translate }}</p>
      </div>

      <!-- Project Details -->
      <div *ngIf="selectedProject && !isLoadingDetail" class="detail-content">
        <!-- Detail Header -->
        <div class="detail-header">
          <div class="header-title">
            <i class="fas fa-folder-open"></i>
            <!-- Non-Edit Mode -->
            <h2 *ngIf="!isEditingProjectName">{{ selectedProject.project_name }}</h2>
            <button
              *ngIf="!isEditingProjectName"
              type="button"
              class="edit-project-name-button"
              (click)="startEditProjectName()"
              [matTooltip]="'songProjects.editor.editTitle' | translate">
              <i class="fas fa-edit"></i>
            </button>
            <!-- Edit Mode -->
            <input
              *ngIf="isEditingProjectName"
              type="text"
              class="project-name-input"
              [(ngModel)]="editProjectNameValue"
              (keyup.enter)="saveProjectName()"
              (keyup.escape)="cancelEditProjectName()"
              [placeholder]="'songProjects.editor.projectName' | translate">
            <button
              *ngIf="isEditingProjectName"
              type="button"
              class="save-project-name-button"
              (click)="saveProjectName()"
              [matTooltip]="'common.save' | translate">
              <i class="fas fa-check"></i>
            </button>
            <button
              *ngIf="isEditingProjectName"
              type="button"
              class="cancel-project-name-button"
              (click)="cancelEditProjectName()"
              [matTooltip]="'common.cancel' | translate">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <span class="sync-badge" [ngClass]="getSyncStatusClass(selectedProject.sync_status)">
            {{ 'songProjects.syncStatus.' + selectedProject.sync_status | translate }}
          </span>
        </div>

        <!-- Project Stats -->
        <div class="detail-section-block">
          <h3 class="section-title">
            <i class="fas fa-chart-bar"></i>
            {{ 'songProjects.detail.sections.metadata' | translate }}
          </h3>

          <div class="detail-field-row-3col">
            <div class="detail-field">
              <span class="field-label">{{ 'songProjects.detail.stats.totalFiles' | translate }}</span>
              <div class="readonly-field">{{ selectedProject.total_files }}</div>
            </div>

            <div class="detail-field">
              <span class="field-label">{{ 'songProjects.detail.stats.totalSize' | translate }}</span>
              <div class="readonly-field">{{ formatFileSize(selectedProject.total_size_bytes) }}</div>
            </div>

            <div class="detail-field">
              <span class="field-label">{{ 'songProjects.detail.stats.syncStatus' | translate }}</span>
              <div class="readonly-field">
                {{ 'songProjects.syncStatus.' + selectedProject.sync_status | translate }}
              </div>
            </div>
          </div>

          <div class="detail-field-row">
            <div class="detail-field">
              <span class="field-label">{{ 'songProjects.detail.stats.created' | translate }}</span>
              <div class="readonly-field">{{ selectedProject.created_at | date:'medium' }}</div>
            </div>

            <div class="detail-field">
              <span class="field-label">{{ 'songProjects.detail.stats.updated' | translate }}</span>
              <div class="readonly-field">{{ selectedProject.updated_at | date:'medium' }}</div>
            </div>
          </div>

          <!-- Tags -->
          <div class="detail-field" *ngIf="selectedProject.tags && selectedProject.tags.length > 0">
            <span class="field-label">{{ 'songProjects.editor.tags' | translate }}</span>
            <div class="readonly-field">
              <mat-chip-set>
                <mat-chip *ngFor="let tag of selectedProject.tags">{{ tag }}</mat-chip>
              </mat-chip-set>
            </div>
          </div>
        </div>

        <!-- Folders & Files -->
        <div class="detail-section-block">
          <h3 class="section-title">
            <i class="fas fa-folder"></i>
            {{ 'songProjects.detail.sections.files' | translate }}
          </h3>

          <!-- Folders Accordion -->
          <mat-accordion *ngIf="selectedProject.folders && selectedProject.folders.length > 0">
            <mat-expansion-panel *ngFor="let folder of selectedProject.folders">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <i class="fas fa-folder"></i>
                  <span>{{ folder.folder_name }}</span>
                  <span class="file-count">({{ getFolderContentLabel(folder) }})</span>
                </mat-panel-title>
              </mat-expansion-panel-header>

              <!-- Assigned Assets Sections -->
              <div class="assigned-assets-container">
                <!-- Assigned Songs -->
                <div *ngIf="folder.assigned_songs && folder.assigned_songs.length > 0" class="assigned-assets-section">
                  <h4 class="assets-section-title">
                    <i class="fas fa-music"></i>
                    {{ 'songProjects.detail.assignedSongs' | translate }}
                  </h4>
                  <div *ngFor="let song of folder.assigned_songs" class="asset-item">
                    <div class="asset-info">
                      <i class="fas fa-music"></i>
                      <span class="asset-title">{{ song.title || 'Untitled' }}</span>
                      <span class="asset-badge">{{ song.workflow }}</span>
                      <span *ngIf="song.file_type" class="asset-meta">{{ song.file_type.toUpperCase() }}</span>
                      <span *ngIf="song.file_size_bytes" class="asset-meta">{{ formatFileSize(song.file_size_bytes) }}</span>
                    </div>
                    <button type="button" class="asset-action-button" (click)="openSong(song.id)" [matTooltip]="'songProjects.detail.actions.openSong' | translate">
                      <i class="fas fa-external-link-alt"></i>
                    </button>
                  </div>
                </div>

                <!-- Assigned Sketches -->
                <div *ngIf="folder.assigned_sketches && folder.assigned_sketches.length > 0" class="assigned-assets-section">
                  <h4 class="assets-section-title">
                    <i class="fas fa-pencil-alt"></i>
                    {{ 'songProjects.detail.assignedSketches' | translate }}
                  </h4>
                  <div *ngFor="let sketch of folder.assigned_sketches" class="asset-item">
                    <div class="asset-info">
                      <i class="fas fa-pencil-alt"></i>
                      <span class="asset-title">{{ sketch.title || sketch.prompt }}</span>
                      <span class="asset-badge">{{ sketch.workflow }}</span>
                    </div>
                    <button type="button" class="asset-action-button" (click)="openSketch(sketch.id)" [matTooltip]="'songProjects.detail.actions.openSketch' | translate">
                      <i class="fas fa-external-link-alt"></i>
                    </button>
                  </div>
                </div>

                <!-- Assigned Images -->
                <div *ngIf="folder.assigned_images && folder.assigned_images.length > 0" class="assigned-assets-section">
                  <h4 class="assets-section-title">
                    <i class="fas fa-image"></i>
                    {{ 'songProjects.detail.assignedImages' | translate }}
                  </h4>
                  <div *ngFor="let image of folder.assigned_images" class="asset-item">
                    <div class="asset-info">
                      <i class="fas fa-image"></i>
                      <span class="asset-title">{{ image.title || image.prompt || 'Untitled' }}</span>
                      <span *ngIf="image.composition" class="asset-meta">{{ image.composition }}</span>
                      <span *ngIf="image.width && image.height" class="asset-meta">{{ image.width }}x{{ image.height }}</span>
                    </div>
                    <button type="button" class="asset-action-button" (click)="openImage(image.id)" [matTooltip]="'songProjects.detail.actions.openImage' | translate">
                      <i class="fas fa-external-link-alt"></i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Files in Folder -->
              <div class="folder-files">
                <!-- Upload & Download Buttons -->
                <div class="folder-upload-section">
                  <button
                    type="button"
                    class="upload-button"
                    (click)="uploadFile(folder)"
                  >
                    <i class="fas fa-upload"></i>
                    <span>{{ 'songProjects.detail.actions.uploadFile' | translate }}</span>
                  </button>
                  <button
                    type="button"
                    class="copy-cli-button"
                    (click)="copyCLICommand(folder)"
                    [title]="'songProjects.detail.actions.copyCLIUploadCommand' | translate"
                  >
                    <i class="fas fa-terminal"></i>
                    <span>{{ 'songProjects.detail.actions.copyCLIUploadCommand' | translate }}</span>
                  </button>
                  <button
                    type="button"
                    class="copy-cli-download-button"
                    (click)="copyCLIDownloadCommand(folder)"
                    [title]="'songProjects.detail.actions.copyCLIDownloadCommand' | translate"
                  >
                    <i class="fas fa-download"></i>
                    <span>{{ 'songProjects.detail.actions.copyCLIDownloadCommand' | translate }}</span>
                  </button>
                </div>

                <div *ngIf="!folder.files || folder.files.length === 0" class="empty-folder">
                  <p>{{ 'songProjects.detail.noFiles' | translate }}</p>
                </div>

                <div *ngFor="let file of folder.files" class="file-item">
                  <div class="file-info">
                    <i class="fas fa-file"></i>
                    <span class="filename" [title]="file.relative_path">{{ getFilePathInFolder(file.relative_path, folder.folder_name) }}</span>
                    <span class="filesize">{{ formatFileSize(file.file_size_bytes) }}</span>
                  </div>
                  <button
                    *ngIf="file.download_url"
                    type="button"
                    class="file-download-button"
                    (click)="downloadFile(file.download_url!)"
                  >
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>
            </mat-expansion-panel>
          </mat-accordion>

          <div *ngIf="!selectedProject.folders || selectedProject.folders.length === 0" class="empty-folder">
            <p>{{ 'songProjects.detail.noFiles' | translate }}</p>
          </div>
        </div>

        <!-- Detail Actions -->
        <div class="detail-actions">
          <button type="button" class="action-button refresh-button" (click)="refreshProject()">
            <i class="fas fa-sync-alt"></i>
            <span>{{ 'common.refresh' | translate }}</span>
          </button>
          <button type="button" class="action-button delete-button" (click)="deleteProject()">
            <i class="fas fa-trash"></i>
            <span>{{ 'songProjects.list.actions.delete' | translate }}</span>
          </button>
        </div>
      </div>
    </mat-card>
  </div>
</div>
