<div class="sketch-creator-container">
  <mat-card class="sketch-creator-card">
    <mat-card-content>
      <!-- Header -->
      <div class="sketch-creator-header">
        <div class="sketch-creator-title">
          <h2>
            <i class="fas fa-lightbulb"></i>
            {{ (isEditMode ? 'songSketch.creator.titleEdit' : 'songSketch.creator.title') | translate }}
          </h2>
        </div>
      </div>

        <!-- Form -->
        <form [formGroup]="sketchForm" (ngSubmit)="saveSketch()">
          <!-- Title Field -->
          <div class="form-group">
            <label for="title">
              {{ 'songSketch.creator.fields.title' | translate }}
              <span class="required">*</span>
            </label>
            <div class="prompt-input-group">
              <input
                id="title"
                type="text"
                formControlName="title"
                [placeholder]="'songSketch.creator.fields.titlePlaceholder' | translate"
                required
                maxlength="500"
                [disabled]="isSaving"
                class="title-input">
              <div class="title-dropdown-container" (click)="$event.stopPropagation()">
                <button
                  type="button"
                  (click)="toggleTitleDropdown(); $event.stopPropagation()"
                  [disabled]="isSaving || isGeneratingTitle"
                  class="magic-icon-button"
                  [title]="'songSketch.creator.buttons.titleActions' | translate">
                  <i class="fas fa-ellipsis-vertical" *ngIf="!isGeneratingTitle"></i>
                  <i class="fas fa-spinner fa-spin" *ngIf="isGeneratingTitle"></i>
                </button>
                <div class="dropdown-menu" *ngIf="showTitleDropdown"
                     (click)="$event.stopPropagation()">
                  <button
                    type="button"
                    class="dropdown-item"
                    [disabled]="isSaving || isGeneratingTitle"
                    (click)="selectTitleAction('generate'); $event.stopPropagation()">
                    <i class="fas fa-wand-magic-sparkles"></i>
                    <span>{{ 'songSketch.creator.buttons.generateTitle' | translate }}</span>
                    <i class="fas fa-spinner fa-spin action-spinner"
                       *ngIf="isGeneratingTitle"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="char-counter">
              {{ 'songSketch.creator.fields.titleCharCounter' | translate: {count: sketchForm.get('title')?.value?.length || 0, max: 500} }}
            </div>
          </div>

          <!-- Lyrics Field -->
          <div class="form-group">
            <label for="lyrics">
              {{ 'songSketch.creator.fields.lyrics' | translate }}
              <span class="required">*</span>
            </label>
            <div class="prompt-input-group">
              <textarea
                id="lyrics"
                formControlName="lyrics"
                [placeholder]="'songSketch.creator.fields.lyricsPlaceholder' | translate"
                required
                [disabled]="isSaving"
                rows="10"
                maxlength="10000"
                class="form-textarea">
              </textarea>
              <button
                type="button"
                (click)="navigateToLyricCreator()"
                [disabled]="isSaving"
                class="edit-button"
                [title]="'songSketch.creator.buttons.editLyrics' | translate">
                <i class="fas fa-pen-to-square"></i>
              </button>
            </div>
            <div class="char-counter">
              {{ 'songSketch.creator.fields.lyricsCharCounter' | translate: {count: charCountLyrics, max: 10000} }}
            </div>
          </div>

          <!-- Music Style Prompt Field -->
          <div class="form-group">
            <label for="prompt">
              {{ 'songSketch.creator.fields.prompt' | translate }}
              <span class="required">*</span>
            </label>
            <div class="prompt-input-group">
              <textarea
                id="prompt"
                formControlName="prompt"
                [placeholder]="'songSketch.creator.fields.promptPlaceholder' | translate"
                required
                [disabled]="isSaving"
                rows="2"
                maxlength="1024"
                class="form-textarea prompt-textarea">
              </textarea>
              <button
                type="button"
                (click)="navigateToMusicStylePrompt()"
                [disabled]="isSaving"
                class="edit-button"
                [title]="'songSketch.creator.buttons.editMusicStyle' | translate">
                <i class="fas fa-pen-to-square"></i>
              </button>
            </div>
            <div class="char-counter">
              {{ 'songSketch.creator.fields.promptCharCounter' | translate: {count: charCountPrompt, max: 1024} }}
            </div>
          </div>

          <!-- Workflow Field -->
          <div class="form-group">
            <label for="workflow">{{ 'songSketch.creator.fields.workflow' | translate }}</label>

            <!-- Both modes: Read-only badge -->
            <div class="workflow-readonly">
              <span class="workflow-badge-display">
                {{ getWorkflowLabel(sketchForm.get('workflow')?.value || 'draft') }}
              </span>
              <div class="field-hint">
                {{ 'songSketch.creator.fields.workflowReadonlyHint' | translate }}
              </div>
            </div>
          </div>

          <!-- Tags Selection -->
          <div class="form-group">
            <h4 class="tags-section-title">{{ 'songSketch.creator.tags.title' | translate }}</h4>

            <div class="tags-selection-container">
              <!-- Style Tags -->
              <div class="tag-category">
                <h4 class="category-title" (click)="toggleCategory('style')">
                  <i class="fas fa-music"></i>
                  {{ 'songSketch.creator.tags.styleCategory' | translate }}
                  <i class="fas category-chevron"
                     [class.fa-chevron-down]="!isCategoryExpanded('style')"
                     [class.fa-chevron-up]="isCategoryExpanded('style')"></i>
                </h4>
                <div class="tag-grid" *ngIf="isCategoryExpanded('style')">
                  <button
                    *ngFor="let tag of tagCategories.style"
                    type="button"
                    class="tag-button"
                    [class.selected]="isTagSelected(tag)"
                    [disabled]="isSaving"
                    (click)="toggleTag(tag)">
                    {{ tag }}
                  </button>
                </div>
              </div>

              <!-- Theme Tags -->
              <div class="tag-category">
                <h4 class="category-title" (click)="toggleCategory('theme')">
                  <i class="fas fa-palette"></i>
                  {{ 'songSketch.creator.tags.themeCategory' | translate }}
                  <i class="fas category-chevron"
                     [class.fa-chevron-down]="!isCategoryExpanded('theme')"
                     [class.fa-chevron-up]="isCategoryExpanded('theme')"></i>
                </h4>
                <div class="tag-grid" *ngIf="isCategoryExpanded('theme')">
                  <button
                    *ngFor="let tag of tagCategories.theme"
                    type="button"
                    class="tag-button"
                    [class.selected]="isTagSelected(tag)"
                    [disabled]="isSaving"
                    (click)="toggleTag(tag)">
                    {{ tag }}
                  </button>
                </div>
              </div>

              <!-- Use Case Tags -->
              <div class="tag-category">
                <h4 class="category-title" (click)="toggleCategory('useCase')">
                  <i class="fas fa-tags"></i>
                  {{ 'songSketch.creator.tags.useCaseCategory' | translate }}
                  <i class="fas category-chevron"
                     [class.fa-chevron-down]="!isCategoryExpanded('useCase')"
                     [class.fa-chevron-up]="isCategoryExpanded('useCase')"></i>
                </h4>
                <div class="tag-grid" *ngIf="isCategoryExpanded('useCase')">
                  <button
                    *ngFor="let tag of tagCategories.useCase"
                    type="button"
                    class="tag-button"
                    [class.selected]="isTagSelected(tag)"
                    [disabled]="isSaving"
                    (click)="toggleTag(tag)">
                    {{ tag }}
                  </button>
                </div>
              </div>
            </div>

            <div class="field-hint" *ngIf="selectedTags.length > 0">
              {{ 'songSketch.creator.tags.selectedCount' | translate:{count: selectedTags.length} }}
            </div>
          </div>

          <!-- Action Section -->
          <div class="action-section">
            <div class="utility-actions">
              <!-- Show different buttons based on mode -->
              <button
                *ngIf="!isEditMode"
                type="button"
                class="utility-button"
                (click)="navigateToSketchLibrary()"
                [disabled]="isSaving">
                <i class="fas fa-folder-open"></i>
                <span>{{ 'songSketch.creator.buttons.openLibrary' | translate }}</span>
              </button>
              <button
                *ngIf="isEditMode"
                type="button"
                class="cancel-button"
                (click)="cancelEdit()"
                [disabled]="isSaving">
                <i class="fas fa-times"></i>
                {{ 'songSketch.creator.buttons.cancel' | translate }}
              </button>
              <button
                *ngIf="!isEditMode"
                type="button"
                class="clear-button"
                (click)="resetForm()"
                [disabled]="isSaving">
                <i class="fas fa-eraser"></i>
                {{ 'songSketch.creator.buttons.reset' | translate }}
              </button>
            </div>
            <div class="submit-actions">
              <button
                type="submit"
                class="submit-button"
                [disabled]="!sketchForm.valid || isSaving">
                <i class="fas fa-save" *ngIf="!isSaving"></i>
                <i class="fas fa-spinner fa-spin" *ngIf="isSaving"></i>
                {{ (isEditMode ? 'songSketch.creator.buttons.update' : 'songSketch.creator.buttons.save') | translate }}
              </button>
            </div>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
</div>
