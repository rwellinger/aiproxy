<div class="text-workshop-container">

    <!-- ============================================ -->
    <!-- LIBRARY MODE -->
    <!-- ============================================ -->
    <div *ngIf="!isEditorMode" class="library-mode">
        <mat-card class="list-card">
            <!-- Header -->
            <div class="list-header">
                <div class="header-title">
                    <div class="header-title-group">
                        <h2>
                            <i class="fas fa-pen-fancy"></i>
                            {{ 'workshop.library.title' | translate }}
                        </h2>
                        <div class="count-badge" *ngIf="totalWorkshops > 0">
                            {{ totalWorkshops }}
                        </div>
                    </div>
                    <p class="subtitle">{{ 'workshop.library.subtitle' | translate }}</p>
                </div>
                <button
                    type="button"
                    class="action-button new-button"
                    (click)="createNewWorkshop()"
                    [title]="'workshop.library.newWorkshop' | translate">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <!-- Search -->
            <div class="filters-section">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input
                        type="text"
                        class="search-input"
                        [placeholder]="'workshop.library.searchPlaceholder' | translate"
                        [value]="searchTerm"
                        (input)="onSearch($event)"
                    />
                    <button
                        type="button"
                        class="clear-search-button"
                        *ngIf="searchTerm"
                        (click)="searchTerm = ''; loadWorkshops()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Workshop List -->
            <div class="items-list">
                <!-- Loading State -->
                <div *ngIf="isLoading" class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>{{ 'common.loading' | translate }}</p>
                </div>

                <!-- Empty State -->
                <div *ngIf="!isLoading && workshops.length === 0" class="empty-state">
                    <i class="fas fa-pen-fancy"></i>
                    <p>{{ 'workshop.library.empty' | translate }}</p>
                    <button type="button" class="action-button new-button" (click)="createNewWorkshop()">
                        <i class="fas fa-plus"></i>
                        <span>{{ 'workshop.library.newWorkshop' | translate }}</span>
                    </button>
                </div>

                <!-- Items -->
                <div
                    *ngFor="let workshop of workshops"
                    class="workshop-item"
                    (click)="openWorkshop(workshop)"
                >
                    <div class="item-content">
                        <div class="item-header">
                            <h4 class="item-title">{{ workshop.title }}</h4>
                            <div class="item-badges">
                                <span class="phase-badge" [ngClass]="'phase-' + workshop.current_phase">
                                    {{ getPhaseLabel(workshop.current_phase) }}
                                </span>
                            </div>
                        </div>
                        <div class="item-meta">
                            <span class="meta-date" *ngIf="workshop.connect_topic">
                                <i class="fas fa-comment"></i>
                                {{ workshop.connect_topic }}
                            </span>
                            <span class="meta-date">
                                <i class="fas fa-clock"></i>
                                {{ workshop.created_at | date:'mediumDate' }}
                            </span>
                        </div>
                    </div>
                    <button
                        class="delete-item-btn"
                        (click)="deleteWorkshop($event, workshop)"
                        [title]="'common.delete' | translate">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination" *ngIf="totalWorkshops > pageSize">
                <button
                    class="pagination-btn"
                    [disabled]="!hasPreviousPage"
                    (click)="onPageChange(-1)">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span class="pagination-info">{{ currentPage + 1 }}</span>
                <button
                    class="pagination-btn"
                    [disabled]="!hasNextPage"
                    (click)="onPageChange(1)">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </mat-card>
    </div>

    <!-- ============================================ -->
    <!-- EDITOR MODE -->
    <!-- ============================================ -->
    <div *ngIf="isEditorMode" class="editor-mode">
        <mat-card class="editor-card">
            <mat-card-content>
                <!-- Header -->
                <div class="editor-header">
                    <button type="button" class="back-link" (click)="backToLibrary()">
                        <i class="fas fa-arrow-left"></i>
                        {{ 'workshop.editor.backToLibrary' | translate }}
                    </button>
                    <div class="editor-title">
                        <h2>
                            <i class="fas fa-pen-fancy"></i>
                            {{ 'workshop.editor.titleHeading' | translate }}
                        </h2>
                    </div>
                </div>

                <form [formGroup]="workshopForm">
                    <!-- Title + Actions Row -->
                    <div class="form-group">
                        <label for="workshop_title">{{ 'workshop.editor.titleLabel' | translate }}</label>
                        <div class="prompt-input-group">
                            <input
                                id="workshop_title"
                                type="text"
                                class="title-input"
                                [class.title-invalid]="!workshopForm.get('title')?.value?.trim()"
                                formControlName="title"
                                [placeholder]="'workshop.editor.titlePlaceholder' | translate"
                            />
                            <button
                                type="button"
                                class="magic-icon-button"
                                (click)="generateTitle()"
                                [disabled]="isGeneratingTitle"
                                [title]="'workshop.editor.generateTitle' | translate"
                            >
                                <i class="fas" [ngClass]="isGeneratingTitle ? 'fa-spinner fa-spin' : 'fa-wand-magic-sparkles'"></i>
                            </button>
                        </div>
                    </div>

                    <!-- ============================================ -->
                    <!-- Phase 1: CONNECT -->
                    <!-- ============================================ -->
                    <mat-expansion-panel [expanded]="currentPhase === 'connect'" class="phase-panel">
                        <mat-expansion-panel-header>
                            <mat-panel-title>
                                <i class="fas fa-link"></i>
                                {{ 'workshop.connect.title' | translate }}
                            </mat-panel-title>
                            <mat-panel-description>
                                {{ 'workshop.connect.description' | translate }}
                            </mat-panel-description>
                        </mat-expansion-panel-header>

                        <div class="panel-content">
                            <div class="form-group">
                                <label for="connect_topic">{{ 'workshop.connect.topicLabel' | translate }}</label>
                                <div class="prompt-input-group">
                                    <textarea
                                        *ngIf="!isPreviewMode"
                                        id="connect_topic"
                                        formControlName="connect_topic"
                                        rows="4"
                                        class="form-textarea"
                                        [placeholder]="'workshop.connect.topicPlaceholder' | translate"
                                    ></textarea>
                                    <div
                                        *ngIf="isPreviewMode"
                                        class="markdown-preview"
                                        [innerHTML]="renderMarkdown(workshopForm.get('connect_topic')?.value || '')">
                                    </div>
                                    <button
                                        type="button"
                                        class="magic-icon-button"
                                        (click)="generateInspirations()"
                                        [disabled]="isGeneratingInspirations"
                                        [title]="'workshop.connect.generateInspirations' | translate"
                                    >
                                        <i class="fas" [ngClass]="isGeneratingInspirations ? 'fa-spinner fa-spin' : 'fa-wand-magic-sparkles'"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Inspiration Selection Mode -->
                            <div class="form-group" *ngIf="isSelectingInspirations">
                                <span class="form-label">{{ 'workshop.connect.inspirationsLabel' | translate }}</span>
                                <div class="selection-hint">
                                    <i class="fas fa-hand-pointer"></i>
                                    {{ 'workshop.selection.hint' | translate }}
                                </div>
                                <div class="selectable-items-grid">
                                    <div
                                        *ngFor="let item of inspirationItems"
                                        class="selectable-card"
                                        [class.selected]="item.selected"
                                        (click)="toggleInspirationItem(item)">
                                        <div class="card-check">
                                            <i class="fas" [ngClass]="item.selected ? 'fa-check-circle' : 'fa-circle'"></i>
                                        </div>
                                        <div class="card-content">
                                            <strong>{{ item.heading }}</strong>
                                            <p>{{ item.content }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="selection-actions">
                                    <button
                                        type="button"
                                        class="action-button save-button"
                                        (click)="applyInspirationSelection()"
                                        [disabled]="!hasSelectedInspirations">
                                        <i class="fas fa-check"></i>
                                        <span>{{ 'workshop.selection.applyButton' | translate }}</span>
                                    </button>
                                    <button
                                        type="button"
                                        class="action-button export-button"
                                        (click)="cancelInspirationSelection()">
                                        <i class="fas fa-times"></i>
                                        <span>{{ 'workshop.selection.cancelButton' | translate }}</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Inspirations Normal Mode -->
                            <div class="form-group" *ngIf="!isSelectingInspirations && workshopForm.get('connect_inspirations')?.value">
                                <label for="connect_inspirations">{{ 'workshop.connect.inspirationsLabel' | translate }}</label>
                                <textarea
                                    *ngIf="!isPreviewMode"
                                    id="connect_inspirations"
                                    formControlName="connect_inspirations"
                                    rows="8"
                                    class="form-textarea"
                                ></textarea>
                                <div
                                    *ngIf="isPreviewMode"
                                    class="markdown-preview"
                                    [innerHTML]="renderMarkdown(workshopForm.get('connect_inspirations')?.value || '')">
                                </div>
                            </div>
                        </div>
                    </mat-expansion-panel>

                    <!-- ============================================ -->
                    <!-- Phase 2: COLLECT -->
                    <!-- ============================================ -->
                    <mat-expansion-panel [expanded]="currentPhase === 'collect'" class="phase-panel">
                        <mat-expansion-panel-header>
                            <mat-panel-title>
                                <i class="fas fa-layer-group"></i>
                                {{ 'workshop.collect.title' | translate }}
                            </mat-panel-title>
                            <mat-panel-description>
                                {{ 'workshop.collect.description' | translate }}
                            </mat-panel-description>
                        </mat-expansion-panel-header>

                        <div class="panel-content">
                            <!-- Mindmap -->
                            <div class="form-group">
                                <label for="collect_mindmap">{{ 'workshop.collect.mindmapLabel' | translate }}</label>
                                <div class="prompt-input-group">
                                    <textarea
                                        *ngIf="!isPreviewMode"
                                        id="collect_mindmap"
                                        formControlName="collect_mindmap"
                                        rows="8"
                                        class="form-textarea"
                                        [placeholder]="'workshop.collect.mindmapPlaceholder' | translate"
                                    ></textarea>
                                    <div
                                        *ngIf="isPreviewMode"
                                        class="markdown-preview"
                                        [innerHTML]="renderMarkdown(workshopForm.get('collect_mindmap')?.value || '')">
                                    </div>
                                    <button
                                        type="button"
                                        class="magic-icon-button"
                                        (click)="generateMindmap()"
                                        [disabled]="isGeneratingMindmap"
                                        [title]="'workshop.collect.generateMindmap' | translate"
                                    >
                                        <i class="fas" [ngClass]="isGeneratingMindmap ? 'fa-spinner fa-spin' : 'fa-wand-magic-sparkles'"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Story Selection Mode -->
                            <div class="form-group" *ngIf="isSelectingStories">
                                <span class="form-label">{{ 'workshop.collect.storiesLabel' | translate }}</span>
                                <div class="selection-hint">
                                    <i class="fas fa-hand-pointer"></i>
                                    {{ 'workshop.selection.hint' | translate }}
                                </div>
                                <div class="selectable-items-grid">
                                    <div
                                        *ngFor="let item of storyItems"
                                        class="selectable-card"
                                        [class.selected]="item.selected"
                                        (click)="toggleStoryItem(item)">
                                        <div class="card-check">
                                            <i class="fas" [ngClass]="item.selected ? 'fa-check-circle' : 'fa-circle'"></i>
                                        </div>
                                        <div class="card-content">
                                            <strong>{{ item.heading }}</strong>
                                            <p>{{ item.content }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="selection-actions">
                                    <button
                                        type="button"
                                        class="action-button save-button"
                                        (click)="applyStorySelection()"
                                        [disabled]="!hasSelectedStories">
                                        <i class="fas fa-check"></i>
                                        <span>{{ 'workshop.selection.applyButton' | translate }}</span>
                                    </button>
                                    <button
                                        type="button"
                                        class="action-button export-button"
                                        (click)="cancelStorySelection()">
                                        <i class="fas fa-times"></i>
                                        <span>{{ 'workshop.selection.cancelButton' | translate }}</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Stories Normal Mode -->
                            <div class="form-group" *ngIf="!isSelectingStories">
                                <label for="collect_stories">{{ 'workshop.collect.storiesLabel' | translate }}</label>
                                <div class="prompt-input-group">
                                    <textarea
                                        *ngIf="!isPreviewMode"
                                        id="collect_stories"
                                        formControlName="collect_stories"
                                        rows="8"
                                        class="form-textarea"
                                        [placeholder]="'workshop.collect.storiesPlaceholder' | translate"
                                    ></textarea>
                                    <div
                                        *ngIf="isPreviewMode"
                                        class="markdown-preview"
                                        [innerHTML]="renderMarkdown(workshopForm.get('collect_stories')?.value || '')">
                                    </div>
                                    <button
                                        type="button"
                                        class="magic-icon-button"
                                        (click)="generateStories()"
                                        [disabled]="isGeneratingStories"
                                        [title]="'workshop.collect.generateStories' | translate"
                                    >
                                        <i class="fas" [ngClass]="isGeneratingStories ? 'fa-spinner fa-spin' : 'fa-wand-magic-sparkles'"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Words -->
                            <div class="form-group">
                                <label for="collect_words">{{ 'workshop.collect.wordsLabel' | translate }}</label>
                                <div class="prompt-input-group">
                                    <textarea
                                        *ngIf="!isPreviewMode"
                                        id="collect_words"
                                        formControlName="collect_words"
                                        rows="8"
                                        class="form-textarea"
                                        [placeholder]="'workshop.collect.wordsPlaceholder' | translate"
                                    ></textarea>
                                    <div
                                        *ngIf="isPreviewMode"
                                        class="markdown-preview"
                                        [innerHTML]="renderMarkdown(workshopForm.get('collect_words')?.value || '')">
                                    </div>
                                    <button
                                        type="button"
                                        class="magic-icon-button"
                                        (click)="generateWords()"
                                        [disabled]="isGeneratingWords"
                                        [title]="'workshop.collect.generateWords' | translate"
                                    >
                                        <i class="fas" [ngClass]="isGeneratingWords ? 'fa-spinner fa-spin' : 'fa-wand-magic-sparkles'"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </mat-expansion-panel>

                    <!-- ============================================ -->
                    <!-- Phase 3: SHAPE -->
                    <!-- ============================================ -->
                    <mat-expansion-panel [expanded]="currentPhase === 'shape'" class="phase-panel">
                        <mat-expansion-panel-header>
                            <mat-panel-title>
                                <i class="fas fa-pen-nib"></i>
                                {{ 'workshop.shape.title' | translate }}
                            </mat-panel-title>
                            <mat-panel-description>
                                {{ 'workshop.shape.description' | translate }}
                            </mat-panel-description>
                        </mat-expansion-panel-header>

                        <div class="panel-content">
                            <!-- Structure -->
                            <div class="form-group">
                                <label for="shape_structure">{{ 'workshop.shape.structureLabel' | translate }}</label>
                                <div class="ai-action" *ngIf="!isPreviewMode">
                                    <button type="button" class="secondary-button" (click)="openStructureModal()">
                                        <i class="fas fa-sitemap"></i>
                                        {{ 'workshop.shape.chooseStructure' | translate }}
                                    </button>
                                </div>
                                <textarea
                                    *ngIf="!isPreviewMode"
                                    id="shape_structure"
                                    formControlName="shape_structure"
                                    rows="6"
                                    class="form-textarea"
                                    [placeholder]="'workshop.shape.structurePlaceholder' | translate"
                                ></textarea>
                                <div
                                    *ngIf="isPreviewMode"
                                    class="markdown-preview"
                                    [innerHTML]="renderMarkdown(workshopForm.get('shape_structure')?.value || '')">
                                </div>
                            </div>

                            <!-- Rhymes -->
                            <div class="form-group">
                                <label for="shape_rhymes">{{ 'workshop.shape.rhymesLabel' | translate }}</label>
                                <div class="prompt-input-group">
                                    <textarea
                                        *ngIf="!isPreviewMode"
                                        id="shape_rhymes"
                                        formControlName="shape_rhymes"
                                        rows="8"
                                        class="form-textarea"
                                        [placeholder]="'workshop.shape.rhymesPlaceholder' | translate"
                                    ></textarea>
                                    <div
                                        *ngIf="isPreviewMode"
                                        class="markdown-preview"
                                        [innerHTML]="renderMarkdown(workshopForm.get('shape_rhymes')?.value || '')">
                                    </div>
                                    <button
                                        type="button"
                                        class="magic-icon-button"
                                        (click)="generateRhymes()"
                                        [disabled]="isGeneratingRhymes"
                                        [title]="'workshop.shape.generateRhymes' | translate"
                                    >
                                        <i class="fas" [ngClass]="isGeneratingRhymes ? 'fa-spinner fa-spin' : 'fa-wand-magic-sparkles'"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Draft -->
                            <div class="form-group">
                                <div class="draft-header">
                                    <label for="shape_draft">{{ 'workshop.shape.draftLabel' | translate }}</label>
                                    <select
                                        [(ngModel)]="draftLanguage"
                                        [ngModelOptions]="{standalone: true}"
                                        class="language-select"
                                        [title]="'workshop.shape.draftLanguage' | translate"
                                        (ngModelChange)="saveWorkshop()"
                                    >
                                        <option *ngFor="let lang of draftLanguages" [value]="lang">{{ lang }}</option>
                                    </select>
                                </div>
                                <div class="prompt-input-group">
                                    <textarea
                                        *ngIf="!isPreviewMode"
                                        id="shape_draft"
                                        formControlName="shape_draft"
                                        rows="12"
                                        class="form-textarea form-textarea-large"
                                        [placeholder]="'workshop.shape.draftPlaceholder' | translate"
                                    ></textarea>
                                    <div
                                        *ngIf="isPreviewMode"
                                        class="markdown-preview markdown-preview-large"
                                        [innerHTML]="renderMarkdown(workshopForm.get('shape_draft')?.value || '')">
                                    </div>
                                    <button
                                        type="button"
                                        class="magic-icon-button"
                                        (click)="generateDraft()"
                                        [disabled]="isGeneratingDraft"
                                        [title]="'workshop.shape.generateDraft' | translate"
                                    >
                                        <i class="fas" [ngClass]="isGeneratingDraft ? 'fa-spinner fa-spin' : 'fa-wand-magic-sparkles'"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </mat-expansion-panel>
                </form>

                <!-- Action Section -->
                <div class="action-section">
                    <div class="utility-actions">
                        <button
                            type="button"
                            class="action-button preview-toggle-button"
                            [class.active]="isPreviewMode"
                            (click)="togglePreviewMode()">
                            <i class="fas" [ngClass]="isPreviewMode ? 'fa-edit' : 'fa-eye'"></i>
                            <span>{{ (isPreviewMode ? 'workshop.preview.exitPreview' : 'workshop.preview.enterPreview') | translate }}</span>
                        </button>
                        <button
                            type="button"
                            class="action-button export-md-button"
                            (click)="exportToMarkdown()"
                            [title]="'workshop.export.markdownTitle' | translate">
                            <i class="fas fa-file-arrow-down"></i>
                            <span>{{ 'workshop.export.markdown' | translate }}</span>
                        </button>
                    </div>
                    <div class="submit-actions">
                        <span class="save-status" *ngIf="saveStatus !== 'idle'">
                            <i class="fas" [ngClass]="saveStatus === 'saving' ? 'fa-spinner fa-spin' : 'fa-check'"></i>
                            {{ (saveStatus === 'saving' ? 'workshop.editor.saving' : 'workshop.editor.saved') | translate }}
                        </span>
                        <button
                            type="button"
                            class="action-button export-button"
                            (click)="exportToSketch()"
                            [disabled]="isExporting || currentPhase === 'completed'">
                            <i class="fas" [ngClass]="isExporting ? 'fa-spinner fa-spin' : 'fa-file-export'"></i>
                            <span>{{ 'workshop.editor.exportToSketch' | translate }}</span>
                        </button>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>
    </div>
</div>
