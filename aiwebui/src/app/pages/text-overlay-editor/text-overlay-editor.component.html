<div class="text-overlay-editor master-detail-layout">
  <div class="editor-grid">
    <!-- Left Panel: Form Controls -->
    <div class="editor-controls-section">
      <mat-card class="editor-controls-card">
        <div class="editor-header">
          <div class="editor-title">
            <h2>
              <i class="fas fa-layer-group"></i>
              {{ 'textOverlayEditor.title' | translate }}
            </h2>
          </div>
        </div>
        <div class="controls-content">
          <form [formGroup]="form" class="form-container">
            <!-- Image Selector -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ 'textOverlayEditor.form.selectImage' | translate }}</mat-label>
              <mat-select formControlName="imageId" (selectionChange)="onImageSelect($event.value)">
                <mat-option *ngFor="let image of images" [value]="image.id">
                  <span class="image-select-option">
                    <span class="image-title">
                      {{ image.title | slice:0:100 }}{{ image.title && image.title.length > 100 ? '...' : '' }}
                    </span>
                    @if (image.composition === 'album-cover') {
                      <span class="badge badge-album-cover">Album Cover</span>
                    }
                  </span>
                </mat-option>
              </mat-select>
              <mat-error *ngIf="form.get('imageId')?.hasError('required')">
                {{ 'textOverlayEditor.form.imageRequired' | translate }}
              </mat-error>
            </mat-form-field>

            <!-- Font Style -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ 'textOverlayEditor.form.fontStyle' | translate }}</mat-label>
              <mat-select formControlName="fontStyle">
                <mat-option *ngFor="let font of fontStyles" [value]="font.value">
                  <span class="font-style-option">
                    <i [class]="font.icon"></i>
                    <span>{{ font.label }}</span>
                  </span>
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-divider></mat-divider>

            <!-- Accordion for Title and Artist Settings -->
            <mat-accordion>
              <!-- Title Section -->
              <mat-expansion-panel [expanded]="true">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <i class="fas fa-heading"></i>
                    {{ 'textOverlayEditor.titleSection' | translate }}
                  </mat-panel-title>
                </mat-expansion-panel-header>

                <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ 'textOverlayEditor.form.title' | translate }}</mat-label>
              <input matInput formControlName="title" maxlength="50" />
              <mat-error *ngIf="form.get('title')?.hasError('required')">
                {{ 'textOverlayEditor.form.titleRequired' | translate }}
              </mat-error>
            </mat-form-field>

            <!-- Title Position (Custom Only) -->
            <div class="position-field">
              <div class="position-field__label">{{ 'textOverlayEditor.form.titlePosition' | translate }}</div>

              <div class="custom-position-controls">
                <button
                  mat-stroked-button
                  type="button"
                  [class.active]="isCanvasClickMode && currentClickTarget === 'title'"
                  (click)="activateCanvasClick('title')">
                  {{ 'textOverlayEditor.form.clickOnImage' | translate }}
                </button>

                <div class="coordinate-inputs">
                  <mat-form-field appearance="outline" class="coord-field">
                    <mat-label>{{ 'textOverlayEditor.form.coordinateX' | translate }}</mat-label>
                    <input matInput type="number" formControlName="titlePositionCustomX"
                           min="0" max="100" step="1">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="coord-field">
                    <mat-label>{{ 'textOverlayEditor.form.coordinateY' | translate }}</mat-label>
                    <input matInput type="number" formControlName="titlePositionCustomY"
                           min="0" max="100" step="1">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="font-size-field">
                    <mat-label>{{ 'textOverlayEditor.form.fontSize' | translate }}</mat-label>
                    <input matInput type="number" formControlName="titleFontSize"
                           min="20" max="300" step="5">
                    <span matTextSuffix>px</span>
                  </mat-form-field>
                </div>
              </div>
            </div>

            <div class="color-group">
              <mat-form-field appearance="outline" class="color-field">
                <mat-label>{{ 'textOverlayEditor.form.textColor' | translate }}</mat-label>
                <input matInput type="color" formControlName="titleColor" />
              </mat-form-field>

              <mat-form-field appearance="outline" class="color-field">
                <mat-label>{{ 'textOverlayEditor.form.outlineColor' | translate }}</mat-label>
                <input matInput type="color" formControlName="titleOutlineColor" />
              </mat-form-field>
            </div>
              </mat-expansion-panel>

              <!-- Artist Section (Optional) -->
              <mat-expansion-panel>
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <i class="fas fa-user-pen"></i>
                    {{ 'textOverlayEditor.artistSection' | translate }}
                  </mat-panel-title>
                </mat-expansion-panel-header>

                <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ 'textOverlayEditor.form.artist' | translate }}</mat-label>
              <input matInput formControlName="artist" maxlength="50" />
            </mat-form-field>

            <!-- Artist Position (Custom Only) -->
            <div class="position-field">
              <div class="position-field__label">{{ 'textOverlayEditor.form.artistPosition' | translate }}</div>

              <div class="custom-position-controls">
                <button
                  mat-stroked-button
                  type="button"
                  [class.active]="isCanvasClickMode && currentClickTarget === 'artist'"
                  (click)="activateCanvasClick('artist')">
                  {{ 'textOverlayEditor.form.clickOnImage' | translate }}
                </button>

                <div class="coordinate-inputs">
                  <mat-form-field appearance="outline" class="coord-field">
                    <mat-label>{{ 'textOverlayEditor.form.coordinateX' | translate }}</mat-label>
                    <input matInput type="number" formControlName="artistPositionCustomX"
                           min="0" max="100" step="1">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="coord-field">
                    <mat-label>{{ 'textOverlayEditor.form.coordinateY' | translate }}</mat-label>
                    <input matInput type="number" formControlName="artistPositionCustomY"
                           min="0" max="100" step="1">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="font-size-field">
                    <mat-label>{{ 'textOverlayEditor.form.fontSize' | translate }}</mat-label>
                    <input matInput type="number" formControlName="artistFontSize"
                           min="10" max="200" step="5">
                    <span matTextSuffix>px</span>
                  </mat-form-field>
                </div>
              </div>
            </div>

            <div class="color-group-with-reset">
              <div class="color-field-wrapper">
                <mat-form-field appearance="outline" class="color-field">
                  <mat-label>{{ 'textOverlayEditor.form.artistColor' | translate }}</mat-label>
                  <input matInput type="color" formControlName="artistColor" />
                </mat-form-field>
                <button
                  mat-icon-button
                  type="button"
                  class="color-reset-button"
                  [disabled]="!form.get('artistColor')?.value"
                  (click)="form.get('artistColor')?.setValue(null)"
                  matTooltip="{{ 'textOverlayEditor.form.useTitleColor' | translate }}">
                  <i class="fas fa-times"></i>
                </button>
              </div>

              <div class="color-field-wrapper">
                <mat-form-field appearance="outline" class="color-field">
                  <mat-label>{{ 'textOverlayEditor.form.artistOutlineColor' | translate }}</mat-label>
                  <input matInput type="color" formControlName="artistOutlineColor" />
                </mat-form-field>
                <button
                  mat-icon-button
                  type="button"
                  class="color-reset-button"
                  [disabled]="!form.get('artistOutlineColor')?.value"
                  (click)="form.get('artistOutlineColor')?.setValue(null)"
                  matTooltip="{{ 'textOverlayEditor.form.useTitleColor' | translate }}">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>

            <!-- Artist Font Override -->
            <mat-checkbox formControlName="useCustomArtistFont">
              {{ 'textOverlayEditor.form.useCustomArtistFont' | translate }}
            </mat-checkbox>

            @if (form.get('useCustomArtistFont')?.value) {
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>{{ 'textOverlayEditor.form.artistFontStyle' | translate }}</mat-label>
                <mat-select formControlName="artistFontStyle">
                  @for (style of fontStyles; track style.value) {
                    <mat-option [value]="style.value">
                      <span class="font-style-option">
                        <i [class]="style.icon"></i>
                        <span>{{ style.label }}</span>
                      </span>
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>
            }
              </mat-expansion-panel>
            </mat-accordion>

            <mat-divider></mat-divider>

            <!-- Action Buttons -->
            <div class="button-group">
              <button
                type="button"
                (click)="applyTextOverlay()"
                [disabled]="!form.valid || isProcessing"
                class="action-button">
                <mat-spinner *ngIf="isProcessing" diameter="20" class="button-spinner"></mat-spinner>
                <span *ngIf="!isProcessing">{{ 'textOverlayEditor.buttons.apply' | translate }}</span>
              </button>

              <button
                type="button"
                (click)="downloadResult()"
                [disabled]="!resultImageFilePath"
                class="action-button action-button--secondary">
                <i class="fas fa-download"></i>
                <span>{{ 'textOverlayEditor.buttons.download' | translate }}</span>
              </button>
            </div>
          </form>
        </div>
      </mat-card>
    </div>

    <!-- Right Panel: Canvas Preview -->
    <div class="editor-preview-section">
      <mat-card class="editor-preview-card">
        <div class="preview-header">
          <div class="preview-title">
            <h2>
              <i class="fas fa-eye"></i>
              {{ 'textOverlayEditor.preview.title' | translate }}
            </h2>
          </div>
        </div>
        <div class="preview-content">
          <div class="canvas-wrapper">
            <canvas #canvas
                    class="preview-canvas"
                    [class.clickable]="isCanvasClickMode"
                    (click)="onCanvasClick($event)">
            </canvas>
            <p *ngIf="!selectedImage" class="placeholder-text">
              {{ 'textOverlayEditor.preview.selectImagePlaceholder' | translate }}
            </p>
          </div>
        </div>
      </mat-card>
    </div>
  </div>
</div>
