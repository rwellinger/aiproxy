<div class="release-editor-container">
  <mat-card class="editor-card">
    <!-- Header -->
    <div class="editor-header">
      <div class="header-title">
        <i class="fas fa-compact-disc"></i>
        <h2 *ngIf="!isEditMode">{{ 'songRelease.editor.titleCreate' | translate }}</h2>
        <h2 *ngIf="isEditMode">{{ 'songRelease.editor.titleEdit' | translate }}</h2>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-state">
      <i class="fas fa-spinner fa-spin"></i>
      <p>{{ 'songRelease.editor.loading' | translate }}</p>
    </div>

    <!-- Form -->
    <form *ngIf="!isLoading" [formGroup]="releaseForm" (ngSubmit)="save()" class="editor-form">
      <!-- Basic Information -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fas fa-info-circle"></i>
          {{ 'songRelease.editor.sections.basic' | translate }}
        </h3>

        <div class="form-row">
          <!-- Type -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ 'songRelease.editor.type' | translate }}</mat-label>
            <mat-select formControlName="type" required>
              <mat-option *ngFor="let type of releaseTypes" [value]="type">
                {{ 'songRelease.types.' + type | translate }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="releaseForm.get('type')?.invalid">
              {{ getFieldError('type') }}
            </mat-error>
          </mat-form-field>

          <!-- Status -->
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>{{ 'songRelease.editor.status' | translate }}</mat-label>
            <mat-select formControlName="status" required>
              <mat-option *ngFor="let status of releaseStatuses" [value]="status">
                {{ 'songRelease.statuses.' + status | translate }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="releaseForm.get('status')?.invalid">
              {{ getFieldError('status') }}
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Name -->
        <mat-form-field appearance="outline" class="form-field-full">
          <mat-label>{{ 'songRelease.editor.name' | translate }}</mat-label>
          <input matInput formControlName="name" maxlength="200" required>
          <mat-error *ngIf="releaseForm.get('name')?.invalid">
            {{ getFieldError('name') }}
          </mat-error>
        </mat-form-field>

        <!-- Genre -->
        <mat-form-field appearance="outline" class="form-field-full">
          <mat-label>{{ 'songRelease.editor.genre' | translate }}</mat-label>
          <input matInput formControlName="genre" maxlength="100" required>
          <mat-error *ngIf="releaseForm.get('genre')?.invalid">
            {{ getFieldError('genre') }}
          </mat-error>
        </mat-form-field>

        <!-- Description -->
        <mat-form-field appearance="outline" class="form-field-full">
          <mat-label>{{ 'songRelease.editor.description' | translate }}</mat-label>
          <textarea matInput formControlName="description" rows="4" maxlength="2000"></textarea>
        </mat-form-field>

        <!-- Tags -->
        <mat-form-field appearance="outline" class="form-field-full">
          <mat-label>{{ 'songRelease.editor.tags' | translate }}</mat-label>
          <input matInput formControlName="tags" maxlength="500"
                 [placeholder]="'songRelease.editor.tagsPlaceholder' | translate">
          <mat-hint>{{ 'songRelease.editor.tagsHint' | translate }}</mat-hint>
        </mat-form-field>
      </div>

      <!-- Project Assignment -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fas fa-folder-open"></i>
          {{ 'songRelease.editor.sections.projects' | translate }}
        </h3>

        <div class="project-assignment">
          <div class="assigned-projects" *ngIf="assignedProjectNames.length > 0">
            <div class="project-chips">
              <span *ngFor="let projectName of assignedProjectNames" class="project-chip">
                <i class="fas fa-folder"></i>
                {{ projectName }}
              </span>
            </div>
          </div>

          <div class="no-projects" *ngIf="assignedProjectNames.length === 0">
            <i class="fas fa-exclamation-triangle"></i>
            <p>{{ 'songRelease.editor.noProjectsAssigned' | translate }}</p>
          </div>

          <button type="button" class="assign-button" (click)="openAssignToProjectDialog()">
            <i class="fas fa-link"></i>
            <span>{{ 'songRelease.editor.assignProjects' | translate }}</span>
          </button>
        </div>
      </div>

      <!-- Industry Metadata (conditional based on status) -->
      <div class="form-section" *ngIf="shouldShowField('upc')">
        <h3 class="section-title">
          <i class="fas fa-barcode"></i>
          {{ 'songRelease.editor.sections.industry' | translate }}
        </h3>

        <div class="form-row">
          <!-- UPC -->
          <mat-form-field appearance="outline" class="form-field" *ngIf="shouldShowField('upc')">
            <mat-label>{{ 'songRelease.editor.upc' | translate }}</mat-label>
            <input matInput formControlName="upc" maxlength="50">
            <mat-error *ngIf="releaseForm.get('upc')?.invalid">
              {{ getFieldError('upc') }}
            </mat-error>
          </mat-form-field>

          <!-- ISRC -->
          <mat-form-field appearance="outline" class="form-field" *ngIf="shouldShowField('isrc')">
            <mat-label>{{ 'songRelease.editor.isrc' | translate }}</mat-label>
            <input matInput formControlName="isrc" maxlength="50">
            <mat-error *ngIf="releaseForm.get('isrc')?.invalid">
              {{ getFieldError('isrc') }}
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Copyright Info -->
        <mat-form-field appearance="outline" class="form-field-full" *ngIf="shouldShowField('copyright_info')">
          <mat-label>{{ 'songRelease.editor.copyrightInfo' | translate }}</mat-label>
          <textarea matInput formControlName="copyright_info" rows="3" maxlength="500"></textarea>
          <mat-error *ngIf="releaseForm.get('copyright_info')?.invalid">
            {{ getFieldError('copyright_info') }}
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Dates (conditional based on status) -->
      <div class="form-section" *ngIf="shouldShowField('upload_date') || shouldShowField('release_date')">
        <h3 class="section-title">
          <i class="fas fa-calendar-alt"></i>
          {{ 'songRelease.editor.sections.dates' | translate }}
        </h3>

        <div class="form-row">
          <!-- Upload Date -->
          <mat-form-field appearance="outline" class="form-field" *ngIf="shouldShowField('upload_date')">
            <mat-label>{{ 'songRelease.editor.uploadDate' | translate }}</mat-label>
            <input matInput [matDatepicker]="uploadDatePicker" formControlName="upload_date">
            <mat-datepicker-toggle matIconSuffix [for]="uploadDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #uploadDatePicker></mat-datepicker>
            <mat-error *ngIf="releaseForm.get('upload_date')?.invalid">
              {{ getFieldError('upload_date') }}
            </mat-error>
          </mat-form-field>

          <!-- Release Date -->
          <mat-form-field appearance="outline" class="form-field" *ngIf="shouldShowField('release_date')">
            <mat-label>{{ 'songRelease.editor.releaseDate' | translate }}</mat-label>
            <input matInput [matDatepicker]="releaseDatePicker" formControlName="release_date">
            <mat-datepicker-toggle matIconSuffix [for]="releaseDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #releaseDatePicker></mat-datepicker>
            <mat-error *ngIf="releaseForm.get('release_date')?.invalid">
              {{ getFieldError('release_date') }}
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Downtaken Date -->
        <mat-form-field appearance="outline" class="form-field-full" *ngIf="shouldShowField('downtaken_date')">
          <mat-label>{{ 'songRelease.editor.downtakenDate' | translate }}</mat-label>
          <input matInput [matDatepicker]="downtakenDatePicker" formControlName="downtaken_date">
          <mat-datepicker-toggle matIconSuffix [for]="downtakenDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #downtakenDatePicker></mat-datepicker>
          <mat-error *ngIf="releaseForm.get('downtaken_date')?.invalid">
            {{ getFieldError('downtaken_date') }}
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Rejection/Downtaken Reasons (conditional) -->
      <div class="form-section" *ngIf="shouldShowField('rejected_reason') || shouldShowField('downtaken_reason')">
        <h3 class="section-title">
          <i class="fas fa-exclamation-circle"></i>
          {{ 'songRelease.editor.sections.reasons' | translate }}
        </h3>

        <!-- Rejected Reason -->
        <mat-form-field appearance="outline" class="form-field-full" *ngIf="shouldShowField('rejected_reason')">
          <mat-label>{{ 'songRelease.editor.rejectedReason' | translate }}</mat-label>
          <textarea matInput formControlName="rejected_reason" rows="4" maxlength="500"></textarea>
          <mat-error *ngIf="releaseForm.get('rejected_reason')?.invalid">
            {{ getFieldError('rejected_reason') }}
          </mat-error>
        </mat-form-field>

        <!-- Downtaken Reason -->
        <mat-form-field appearance="outline" class="form-field-full" *ngIf="shouldShowField('downtaken_reason')">
          <mat-label>{{ 'songRelease.editor.downtakenReason' | translate }}</mat-label>
          <textarea matInput formControlName="downtaken_reason" rows="4" maxlength="500"></textarea>
          <mat-error *ngIf="releaseForm.get('downtaken_reason')?.invalid">
            {{ getFieldError('downtaken_reason') }}
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Cover Image (always visible) -->
      <div class="form-section">
        <h3 class="section-title">
          <i class="fas fa-image"></i>
          {{ 'songRelease.editor.sections.cover' | translate }}
        </h3>

        <div class="cover-upload">
          <div class="cover-preview" *ngIf="coverPreviewUrl">
            <img [src]="coverPreviewUrl" alt="Cover Preview">
            <button type="button" class="remove-cover-button" (click)="removeCoverImage()">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="cover-preview cover-placeholder-preview" *ngIf="!coverPreviewUrl && releaseForm.get('name')?.value" [style.background-color]="getColorFromString(releaseForm.get('name')?.value)">
            <span class="initials">{{ getInitials(releaseForm.get('name')?.value) }}</span>
          </div>

          <div class="cover-upload-controls">
            <label for="coverFileInput" class="upload-label">
              <i class="fas fa-upload"></i>
              <span>{{ 'songRelease.editor.uploadCover' | translate }}</span>
            </label>
            <input
              id="coverFileInput"
              type="file"
              accept="image/*"
              (change)="onCoverFileSelected($event)"
              class="file-input">
            <p class="upload-hint">{{ 'songRelease.editor.coverHint' | translate }}</p>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="editor-actions">
        <button type="button" class="action-button cancel-button" (click)="cancel()" [disabled]="isSaving">
          <i class="fas fa-times"></i>
          <span>{{ 'common.cancel' | translate }}</span>
        </button>

        <button type="submit" class="action-button save-button" [disabled]="isSaving || releaseForm.invalid">
          <i class="fas fa-save"></i>
          <span *ngIf="!isSaving">{{ 'common.save' | translate }}</span>
          <span *ngIf="isSaving">{{ 'common.saving' | translate }}</span>
        </button>
      </div>
    </form>
  </mat-card>
</div>
