<div class="song-generator-container master-detail-layout">
    <!-- Main Content Grid -->
    <div class="generator-grid">
        <!-- Left Side: Song Creation Card -->
        <div class="song-creation-section">
            <mat-card class="song-creation-card">
                <mat-card-content>
                    <div class="controls-content">
                        <div class="song-generator-header">
                            <div class="song-generator-title">
                                <h2>
                                    <i class="fas fa-music"></i>
                                    {{ 'songGenerator.title' | translate }}
                                </h2>
                            </div>
                        </div>

                        <form [formGroup]="songForm" (ngSubmit)="onSubmit()">

                            <!-- Mode Selection -->
                            <div class="form-group">
                                <div class="segment-control">
                                    <button
                                            type="button"
                                            class="segment-button"
                                            [class.active]="!isInstrumentalMode"
                                            [disabled]="isLoading"
                                            (click)="setMode('song')">
                                        <i class="fas fa-microphone"></i>
                                        <span>{{ 'songGenerator.withLyrics' | translate }}</span>
                                    </button>
                                    <button
                                            type="button"
                                            class="segment-button"
                                            [class.active]="isInstrumentalMode"
                                            [disabled]="isLoading"
                                            (click)="setMode('instrumental')">
                                        <i class="fas fa-guitar"></i>
                                        <span>{{ 'songGenerator.instrumental' | translate }}</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Sketch Selection -->
                            <div class="form-group" *ngIf="sketches.length > 0">
                                <label for="sketch-select">{{ 'songGenerator.selectSketch.label' | translate }}</label>
                                <div class="sketch-select-group">
                                    <select
                                        id="sketch-select"
                                        class="sketch-select"
                                        [disabled]="isLoading"
                                        [(ngModel)]="selectedSketchId"
                                        [ngModelOptions]="{standalone: true}"
                                        (ngModelChange)="onSketchIdChanged($event)">
                                        <option [ngValue]="null">{{ 'songGenerator.selectSketch.placeholder' | translate }}</option>
                                        <option
                                            *ngFor="let sketch of sketches"
                                            [ngValue]="sketch.id">
                                            {{ sketch.title || ('songSketch.library.untitled' | translate) }}
                                        </option>
                                    </select>
                                    <button
                                        *ngIf="selectedSketch"
                                        type="button"
                                        class="clear-sketch-btn"
                                        (click)="clearSketch()"
                                        [disabled]="isLoading"
                                        [title]="'songGenerator.selectSketch.clear' | translate">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <!-- Workflow Display (readonly) -->
                                <div *ngIf="selectedSketch" class="sketch-workflow-info">
                                    <span class="workflow-label">{{ 'songGenerator.sketch.workflowLabel' | translate }}</span>
                                    <span class="workflow-badge-display">
                                        {{ getSketchWorkflowLabel(selectedSketch.workflow) }}
                                    </span>
                                    <div class="field-hint">
                                        {{ 'songGenerator.sketch.workflowHint' | translate }}
                                    </div>
                                </div>
                            </div>

                            <!-- Title Field (readonly) -->
                            <div class="form-group">
                                <label for="title">{{ 'songGenerator.titleLabel' | translate }}<span class="required"
                                                               *ngIf="isInstrumentalMode"> {{ 'songGenerator.titleRequired' | translate }}</span></label>
                                <input
                                    id="title"
                                    type="text"
                                    formControlName="title"
                                    [placeholder]="'songGenerator.titlePlaceholder' | translate"
                                    [required]="isInstrumentalMode"
                                    maxlength="50"
                                    readonly
                                    class="title-input readonly-input">
                                <div class="char-counter">{{ 'songGenerator.charCounter' | translate: {count: songForm.get('title')?.value?.length || 0} }}</div>
                            </div>

                            <div class="form-group">
                                <label for="lyrics">{{ 'songGenerator.lyricsLabel' | translate }}</label>
                                <textarea
                                    id="lyrics"
                                    formControlName="lyrics"
                                    [placeholder]="'songGenerator.lyricsPlaceholder' | translate"
                                    [required]="!isInstrumentalMode"
                                    readonly
                                    class="lyrics-input readonly-input"
                                    [class.disabled-section]="isInstrumentalMode">
                                </textarea>
                                <div class="lyrics-char-count" *ngIf="songForm.get('lyrics')?.value">
                                    {{ songForm.get('lyrics')?.value?.length || 0 }} {{ 'songGenerator.charactersCount' | translate }}
                                </div>
                                <div class="instrumental-notice" *ngIf="isInstrumentalMode">
                                    <i class="fas fa-info-circle"></i>
                                    {{ 'songGenerator.instrumentalNotice' | translate }}
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="prompt">{{ 'songGenerator.musicStyleLabel' | translate }}</label>
                                <textarea
                                    id="prompt"
                                    formControlName="prompt"
                                    [placeholder]="'songGenerator.musicStylePlaceholder' | translate"
                                    required
                                    maxlength="1024"
                                    readonly
                                    class="prompt-input readonly-input">
                                </textarea>
                                <div class="lyrics-char-count" *ngIf="songForm.get('prompt')?.value">
                                    {{ songForm.get('prompt')?.value?.length || 0 }} / 1024 {{ 'songGenerator.charactersCount' | translate }}
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="model">{{ 'songGenerator.modelLabel' | translate }}</label>
                                <select id="model" formControlName="model" required [disabled]="isLoading"
                                        class="model-select">
                                    <option value="auto">Auto</option>
                                    <option value="mureka-7.5">Mureka 7.5</option>
                                    <option value="mureka-7">Mureka 7</option>
                                    <option value="mureka-6">Mureka 6</option>
                                    <option value="mureka-o1">Mureka o1</option>
                                </select>
                            </div>

                            <!-- Storage Health Warning (Preventive UX) -->
                            <div *ngIf="!isStorageHealthy && !isCheckingStorage" class="storage-warning" style="margin-bottom: 1rem; padding: 1rem; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; color: #856404;">
                                <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                                <strong>Storage Unavailable:</strong> Song generation is temporarily disabled. The storage backend (MinIO) is not reachable. Please try again later or contact support.
                            </div>

                            <div class="button-group">
                                <button type="submit"
                                        [disabled]="songForm.invalid || isLoading || !isStorageHealthy || isCheckingStorage"
                                        class="create-button">
                                    <i class="fas fa-spinner fa-spin" *ngIf="isLoading || isCheckingStorage"></i>
                                    <i class="fas fa-music" *ngIf="!isLoading && !isCheckingStorage"></i>
                                    {{ isCheckingStorage ? 'Checking storage...' : (isLoading ? ('songGenerator.creating' | translate) : (isInstrumentalMode ? ('songGenerator.createInstrumental' | translate) : ('songGenerator.createButton' | translate))) }}
                                </button>
                            </div>

                            <div *ngIf="isLoading && loadingMessage" class="loading-status">
                                <small class="loading-text">
                                    <i class="fas fa-info-circle"></i>
                                    {{ loadingMessage }} - {{ 'songGenerator.loadingMessage' | translate }}
                                </small>
                            </div>
                        </form>
                    </div>
                </mat-card-content>
                <mat-card-actions align="end">
                    <p class="cost-info">
                        <i class="fas fa-info-circle"></i>
                        {{ 'songGenerator.costInfo' | translate }}
                    </p>
                </mat-card-actions>
            </mat-card>
        </div>

        <!-- Right Side: Generated Song Card -->
        <div class="generated-song-section">
            <mat-card class="generated-song-card">
                <mat-card-content>
                    <app-song-detail-panel
                        #songDetailPanel
                        [songId]="currentSongId"
                        [showEditTitle]="true"
                        [showEditTags]="true"
                        [showEditWorkflow]="true"
                        [showRating]="true"
                        [isGenerating]="isLoading"
                        title=""
                        [showMetaInfo]="['id', 'job_id', 'model', 'status', 'created', 'completed']"
                        [placeholderText]="'songView.placeholderText' | translate"
                        [currentlyPlayingId]="currentlyPlaying"
                        (titleChanged)="onTitleChanged($event)"
                        (tagsChanged)="onTagsChanged($event)"
                        (workflowChanged)="onWorkflowChanged($event)"
                        (downloadFlac)="onDownloadFlac($event)"
                        (playAudio)="onPlayAudio($event)"
                        (downloadStems)="onDownloadStems($event)"
                        (copyLyrics)="onCopyLyrics()"
                        (updateRating)="onUpdateRating($event)">
                    </app-song-detail-panel>
                </mat-card-content>
                <mat-card-actions align="end">
                    <div class="detail-actions">
                        <!-- Audio Player -->
                        <div class="player-bar">
                            <!-- Hidden Audio Element -->
                            <audio *ngIf="audioUrl"
                                   #audioPlayer
                                   [src]="audioUrl"
                                   (timeupdate)="onTimeUpdate()"
                                   (loadedmetadata)="onLoadedMetadata()"
                                   (play)="onPlay()"
                                   (pause)="onPause()"
                                   (ended)="stopAudio()">
                            </audio>

                            <div class="player-content" *ngIf="audioUrl">
                                <!-- Song Info -->
                                <div class="song-info">
                                    <i class="fas fa-music song-icon"></i>
                                    <div class="song-text">
                                        <div class="song-title-player">{{ currentSongTitle }}</div>
                                    </div>
                                </div>

                                <!-- Player Controls -->
                                <div class="player-controls">
                                    <button type="button" class="control-btn" (click)="stopAudio()" [title]="'songGenerator.player.stop' | translate">
                                        <i class="fas fa-stop"></i>
                                    </button>
                                    <button type="button" class="control-btn play-btn" (click)="playPauseAudio()"
                                            [title]="'songGenerator.player.playPause' | translate">
                                        <i class="fas" [class.fa-play]="!isPlaying" [class.fa-pause]="isPlaying"></i>
                                    </button>
                                </div>

                                <!-- Progress Section -->
                                <div class="progress-section">
                                    <div class="time-display">{{ formatTime(currentTime) }}</div>
                                    <input type="range"
                                           class="progress-slider"
                                           min="0"
                                           [max]="duration"
                                           [value]="currentTime"
                                           (input)="onSeek($event)"
                                           [disabled]="!isLoaded"
                                           step="0.1">
                                    <div class="time-display">{{ formatTime(duration) }}</div>
                                </div>

                                <!-- Volume Controls -->
                                <div class="volume-controls">
                                    <button type="button" class="control-btn volume-btn" (click)="toggleMute()"
                                            [title]="'songGenerator.player.muteUnmute' | translate">
                                        <i class="fas" [class.fa-volume-high]="volume > 0.5 && !isMuted"
                                           [class.fa-volume-low]="volume <= 0.5 && volume > 0 && !isMuted"
                                           [class.fa-volume-xmark]="isMuted || volume === 0"></i>
                                    </button>
                                    <input type="range"
                                           class="volume-slider"
                                           min="0"
                                           max="1"
                                           step="0.1"
                                           [value]="volume"
                                           (input)="onVolumeChange($event)">
                                </div>
                            </div>

                            <div class="no-audio-message" *ngIf="!audioUrl">
                                <i class="fas fa-music"></i>
                                <span>{{ 'songGenerator.player.selectSongToPlay' | translate }}</span>
                            </div>
                        </div>
                    </div>
                </mat-card-actions>
            </mat-card>
        </div>
    </div>
</div>

