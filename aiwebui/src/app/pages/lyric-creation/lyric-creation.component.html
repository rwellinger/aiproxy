<div class="lyric-creation-container">
    <mat-card class="lyric-creation-card">
        <mat-card-content>
            <div class="lyric-header">
                <div class="lyric-title">
                    <h2>
                        <i class="fas fa-pen"></i>
                        {{ 'lyricCreation.title' | translate }}
                    </h2>
                </div>
                <div *ngIf="isFromSketchCreator && !sectionEditorMode" class="sketch-navigation-buttons">
                    <button
                        type="button"
                        (click)="cancelChanges()"
                        class="cancel-button"
                        [disabled]="isAnyLyricOperationInProgress"
                        [title]="'common.cancel' | translate">
                        <i class="fas fa-times"></i>
                        <span>{{ 'common.cancel' | translate }}</span>
                    </button>
                    <button
                        type="button"
                        (click)="applyChanges()"
                        class="apply-button"
                        [disabled]="isAnyLyricOperationInProgress"
                        [title]="'common.apply' | translate">
                        <i class="fas fa-check"></i>
                        <span>{{ 'common.apply' | translate }}</span>
                    </button>
                </div>
            </div>

            <form [formGroup]="lyricForm">
                <!-- Classic View (Default) -->
                <div class="form-group" *ngIf="!sectionEditorMode">
                    <textarea
                            id="lyrics"
                            formControlName="lyrics"
                            [placeholder]="'lyricCreation.lyricsPlaceholder' | translate"
                            class="lyrics-textarea">
                    </textarea>
                    <div class="lyrics-char-count" *ngIf="characterCount > 0">
                        {{ characterCount }} {{ 'lyricCreation.charactersCount' | translate }}
                    </div>
                </div>

                <!-- Section Editor Mode -->
                <div class="form-group" *ngIf="sectionEditorMode">
                    <div class="section-editor-container">
                        <!-- Left Panel: Navigator -->
                        <div class="section-navigator">
                            <div class="navigator-header">
                                <h3>{{ 'lyricCreation.sectionEditor.sections' | translate }}</h3>
                                <span class="section-count">{{ sections.length }}</span>
                            </div>

                            <div class="section-list">
                                <div
                                        *ngFor="let section of sections"
                                        class="section-card"
                                        [class.active]="section === activeSection"
                                        (click)="selectSection(section)">
                                    <div class="section-label">
                                        <i class="fas fa-music"></i>
                                        {{ section.label }}
                                    </div>
                                    <div class="section-preview">
                                        {{ section.content.length > 60 ? (section.content | slice:0:60) + '...' : section.content }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Panel: Workspace -->
                        <div class="section-workspace">
                            <div class="workspace-header">
                                <h3>
                                    <i class="fas fa-edit"></i>
                                    {{ activeSection?.label }}
                                </h3>
                                <div class="workspace-actions">
                                    <button
                                            type="button"
                                            (click)="cancelSectionEditor()"
                                            class="cancel-button">
                                        <i class="fas fa-times"></i>
                                        {{ 'common.cancel' | translate }}
                                    </button>
                                    <button
                                            type="button"
                                            (click)="applyAndCloseSectionEditor()"
                                            class="apply-button">
                                        <i class="fas fa-check"></i>
                                        {{ 'lyricCreation.sectionEditor.apply' | translate }}
                                    </button>
                                </div>
                            </div>

                            <div class="workspace-content">
                                <textarea
                                        *ngIf="activeSection"
                                        [(ngModel)]="activeSection.content"
                                        [ngModelOptions]="{standalone: true}"
                                        [placeholder]="'lyricCreation.sectionEditor.placeholder' | translate"
                                        [disabled]="isAnySectionOperationInProgress"
                                        class="section-textarea">
                                </textarea>

                                <!-- Cleanup Button + Character Count Row -->
                                <div class="section-footer-row" *ngIf="activeSection">
                                    <button
                                            type="button"
                                            (click)="cleanupSectionContent()"
                                            [disabled]="isAnySectionOperationInProgress || !activeSection.content.trim()"
                                            class="cleanup-button">
                                        <i class="fas fa-broom"></i>
                                        {{ 'lyricCreation.cleanupLyrics' | translate }}
                                    </button>
                                    <div class="section-char-count">
                                        {{ activeSection.content.length }} {{ 'lyricCreation.charactersCount' | translate }}
                                    </div>
                                </div>

                                <!-- AI Instructions Textarea -->
                                <div class="ai-instructions-group" *ngIf="activeSection">
                                    <label for="aiInstructions" class="ai-instructions-label">
                                        <i class="fas fa-wand-magic-sparkles"></i>
                                        {{ 'lyricCreation.sectionEditor.aiInstructions' | translate }}
                                    </label>
                                    <textarea
                                            id="aiInstructions"
                                            [(ngModel)]="activeSection.aiInstructions"
                                            [ngModelOptions]="{standalone: true}"
                                            [placeholder]="'lyricCreation.sectionEditor.aiInstructionsPlaceholder' | translate"
                                            [disabled]="isAnySectionOperationInProgress"
                                            class="ai-instructions-textarea">
                                    </textarea>
                                </div>
                            </div>

                            <div class="section-ai-actions">
                                <button
                                        type="button"
                                        (click)="improveSectionAI()"
                                        [disabled]="isAnySectionOperationInProgress"
                                        class="ai-action-button">
                                    <i class="fas fa-magic" *ngIf="!isImprovingSection"></i>
                                    <i class="fas fa-spinner fa-spin" *ngIf="isImprovingSection"></i>
                                    {{ 'lyricCreation.sectionEditor.improve' | translate }}
                                </button>

                                <button
                                        type="button"
                                        (click)="rewriteSectionAI()"
                                        [disabled]="isAnySectionOperationInProgress"
                                        class="ai-action-button">
                                    <i class="fas fa-sync-alt" *ngIf="!isRewritingSection"></i>
                                    <i class="fas fa-spinner fa-spin" *ngIf="isRewritingSection"></i>
                                    {{ 'lyricCreation.sectionEditor.rewrite' | translate }}
                                </button>

                                <button
                                        type="button"
                                        (click)="condenseSectionAI()"
                                        [disabled]="isAnySectionOperationInProgress"
                                        class="ai-action-button">
                                    <i class="fas fa-compress-alt" *ngIf="!isCondensingSection"></i>
                                    <i class="fas fa-spinner fa-spin" *ngIf="isCondensingSection"></i>
                                    {{ 'lyricCreation.sectionEditor.condense' | translate }}
                                </button>

                                <button
                                        type="button"
                                        (click)="optimizeSectionAI()"
                                        [disabled]="isAnySectionOperationInProgress"
                                        class="ai-action-button">
                                    <i class="fas fa-align-left" *ngIf="!isOptimizingSection"></i>
                                    <i class="fas fa-spinner fa-spin" *ngIf="isOptimizingSection"></i>
                                    {{ 'lyricCreation.sectionEditor.optimize' | translate }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="info-notice" *ngIf="!isFromSketchCreator">
                    <i class="fas fa-info-circle"></i>
                    {{ 'lyricCreation.autoSaved' | translate }}
                </div>

                <div class="action-section">
                    <div class="ai-actions">
                        <button
                                type="button"
                                (click)="openLyricArchitectModal()"
                                [disabled]="isAnyLyricOperationInProgress || sectionEditorMode"
                                class="utility-button">
                            <i class="fas fa-layer-group"></i>
                            <span>{{ 'lyricCreation.lyricArchitecture' | translate }}</span>
                        </button>
                        <button
                                type="button"
                                (click)="generateLyrics()"
                                [disabled]="isAnyLyricOperationInProgress || sectionEditorMode || !lyricForm.get('lyrics')?.value?.trim()"
                                class="ai-action-button">
                            <i class="fas fa-music" *ngIf="!isGeneratingLyrics"></i>
                            <i class="fas fa-spinner fa-spin" *ngIf="isGeneratingLyrics"></i>
                            <span>{{ 'lyricCreation.createLyrics' | translate }}</span>
                        </button>
                        <button
                                type="button"
                                (click)="translateLyrics()"
                                [disabled]="isAnyLyricOperationInProgress || sectionEditorMode || !lyricForm.get('lyrics')?.value?.trim()"
                                class="ai-action-button">
                            <i class="fas fa-language" *ngIf="!isTranslatingLyrics"></i>
                            <i class="fas fa-spinner fa-spin" *ngIf="isTranslatingLyrics"></i>
                            <span>{{ 'lyricCreation.translateToEnglish' | translate }}</span>
                        </button>
                        <!-- Edit Dropdown -->
                        <div class="edit-dropdown-container">
                            <button
                                    type="button"
                                    (click)="toggleEditDropdown()"
                                    [disabled]="isAnyLyricOperationInProgress || sectionEditorMode || !characterCount"
                                    class="utility-button"
                                    [title]="'lyricCreation.edit' | translate">
                                <i class="fas fa-edit"></i>
                                <span>{{ 'lyricCreation.edit' | translate }}</span>
                                <i class="fas fa-chevron-down dropdown-chevron"></i>
                            </button>
                            <div class="dropdown-menu" *ngIf="showEditDropdown"
                                 (click)="$event.stopPropagation()">
                                <button
                                        type="button"
                                        class="dropdown-item"
                                        [disabled]="isAnyLyricOperationInProgress"
                                        (click)="selectEditAction('searchReplace')">
                                    <i class="fas fa-search"></i>
                                    <span>{{ 'lyricCreation.searchReplace' | translate }}</span>
                                </button>
                                <button
                                        type="button"
                                        class="dropdown-item"
                                        [disabled]="isAnyLyricOperationInProgress || !characterCount"
                                        (click)="copyLyricsToClipboard(); showEditDropdown = false">
                                    <i class="fas fa-copy"></i>
                                    <span>{{ 'lyricCreation.copyToClipboard' | translate }}</span>
                                </button>
                                <button
                                        type="button"
                                        class="dropdown-item"
                                        [disabled]="isAnyLyricOperationInProgress || !canUndo"
                                        (click)="selectEditAction('undo')">
                                    <i class="fas fa-undo"></i>
                                    <span>{{ 'lyricCreation.undoLastChange' | translate }}</span>
                                </button>
                            </div>
                        </div>

                        <!-- Tools Dropdown -->
                        <div class="tools-dropdown-container">
                            <button
                                    type="button"
                                    (click)="toggleToolsDropdown()"
                                    [disabled]="isAnyLyricOperationInProgress || sectionEditorMode || !characterCount"
                                    class="utility-button"
                                    [title]="'lyricCreation.tools' | translate">
                                <i class="fas fa-tools"></i>
                                <span>{{ 'lyricCreation.tools' | translate }}</span>
                                <i class="fas fa-chevron-down dropdown-chevron"></i>
                            </button>
                            <div class="dropdown-menu" *ngIf="showToolsDropdown"
                                 (click)="$event.stopPropagation()">
                                <button
                                        type="button"
                                        class="dropdown-item"
                                        [disabled]="isAnyLyricOperationInProgress || !hasSections"
                                        [title]="hasSections ? ('lyricCreation.sectionEditor.toggle' | translate) : ('lyricCreation.sectionEditor.noStructure' | translate)"
                                        (click)="selectToolsAction('sectionEditor')">
                                    <i class="fas fa-pen-square"></i>
                                    <span>{{ 'lyricCreation.sectionEditor.toggle' | translate }}</span>
                                </button>
                                <div class="dropdown-separator"></div>
                                <button
                                        type="button"
                                        class="dropdown-item"
                                        [disabled]="isAnyLyricOperationInProgress"
                                        (click)="selectToolsAction('structure')">
                                    <i class="fas fa-layer-group"></i>
                                    <span>{{ 'lyricCreation.applyStructure' | translate }}</span>
                                </button>
                                <button
                                        type="button"
                                        class="dropdown-item"
                                        [disabled]="isAnyLyricOperationInProgress || !hasSections"
                                        [title]="hasSections ? ('lyricCreation.rebuildFromLyrics' | translate) : ('lyricCreation.rebuildFromLyricsDisabled' | translate)"
                                        (click)="selectToolsAction('rebuild')">
                                    <i class="fas fa-sync"></i>
                                    <span>{{ 'lyricCreation.rebuildFromLyrics' | translate }}</span>
                                </button>
                                <div class="dropdown-separator"></div>
                                <button
                                        type="button"
                                        class="dropdown-item"
                                        [disabled]="isAnyLyricOperationInProgress"
                                        (click)="selectToolsAction('cleanup')">
                                    <i class="fas fa-broom"></i>
                                    <span>{{ 'lyricCreation.cleanupLyrics' | translate }}</span>
                                </button>
                                <button
                                        type="button"
                                        class="dropdown-item"
                                        [disabled]="isAnyLyricOperationInProgress"
                                        (click)="selectToolsAction('optimize-phrasing')">
                                    <i class="fas fa-align-left"></i>
                                    <span>{{ 'lyricCreation.optimizePhrasing' | translate }}</span>
                                    <i class="fas fa-spinner fa-spin action-spinner"
                                       *ngIf="isOptimizingPhrasing"></i>
                                </button>
                                <div class="dropdown-separator"></div>
                                <button
                                        type="button"
                                        class="dropdown-item"
                                        [disabled]="isAnyLyricOperationInProgress"
                                        (click)="selectToolsAction('finalize')">
                                    <i class="fas fa-check-double"></i>
                                    <span>{{ 'lyricCreation.finalizeLyrics' | translate }}</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="utility-actions">
                        <button
                                type="button"
                                (click)="clearLyrics()"
                                [disabled]="isAnyLyricOperationInProgress || sectionEditorMode || !characterCount"
                                class="clear-button">
                            <i class="fas fa-trash-alt"></i> {{ 'lyricCreation.resetButton' | translate }}
                        </button>
                    </div>
                </div>
            </form>
        </mat-card-content>
    </mat-card>
</div>
