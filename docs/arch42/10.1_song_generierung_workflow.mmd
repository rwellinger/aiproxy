stateDiagram-v2
    [*] --> SketchCreation

    note right of SketchCreation
        User creates/edits sketch in
        Sketch Creator or Sketch Library
    end note

    SketchCreation --> SketchDraft : Save as 'draft'
    SketchDraft --> OptionalLyricEditing : Edit Lyrics (optional)
    SketchDraft --> SongGeneratorInput : Use Sketch

    OptionalLyricEditing --> SketchDraft : Save changes

    note right of OptionalLyricEditing
        Lyric Editor with AI tools:
        - Improve Section
        - Rewrite Section
        - Extend Section
    end note

    SongGeneratorInput --> TaskCreated : POST /song/generate<br/>{sketch_id, lyrics, prompt}

    note right of TaskCreated
        Song record created with:
        - sketch_id (FK to song_sketches)
        - status = 'PENDING'
        - task_id (Celery)
    end note

    TaskCreated --> QueuedInCelery : Celery Task Start
    QueuedInCelery --> MurekaJobStart : Call Mureka API
    MurekaJobStart --> WaitingForGeneration : Job Submitted

    WaitingForGeneration --> PollingStatus : Check Status Loop (30s)
    PollingStatus --> WaitingForGeneration : Still Processing
    PollingStatus --> GenerationComplete : Success
    PollingStatus --> GenerationFailed : Error/Timeout

    GenerationComplete --> SongChoicesReady : Parse Mureka Results

    note right of SongChoicesReady
        Mureka returns 2 choices:
        - mp3_url, flac_url
        - stem_url (optional)
        - duration, title
    end note

    SongChoicesReady --> DatabaseUpdate : Store Song + Choices
    DatabaseUpdate --> SketchMarkAsUsed : UPDATE song_sketches<br/>workflow='used'
    SketchMarkAsUsed --> UserNotified : Task Complete (SUCCESS)
    UserNotified --> [*]

    GenerationFailed --> ErrorLogged : Store error_message
    ErrorLogged --> [*]

    note left of SketchMarkAsUsed
        Sketch workflow states:
        - draft: Initial state
        - used: Generated successfully
        - archived: User archived
    end note
