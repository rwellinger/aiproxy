sequenceDiagram
    participant User
    participant SketchLib as Sketch Library
    participant SketchCreator as Sketch Creator
    participant LyricEditor as Lyric Editor
    participant SongGen as Song Generator
    participant API as aiproxysrv API
    participant Celery as Celery Worker
    participant Mureka as Mureka API
    participant Ollama as Ollama LLM
    participant DB as PostgreSQL
    participant Redis

    Note over User,Redis: Song Generation Workflow with Sketches

    %% Phase 1: Sketch Creation
    User->>SketchLib: Browse Sketches<br/>(draft, used, archived)

    alt Create New Sketch
        User->>SketchCreator: Create New Sketch
        User->>SketchCreator: Enter Title, Music Style<br/>(Optional: Lyrics)

        opt Generate Title with AI
            SketchCreator->>API: POST /api/chat/ollama<br/>(Generate Title Template)
            API->>Ollama: Ollama Generation
            Ollama-->>API: Generated Title
            API-->>SketchCreator: Title Suggestion
            SketchCreator->>SketchCreator: Apply Title
        end

        SketchCreator->>API: POST /api/v1/sketches
        API->>DB: INSERT song_sketches<br/>(title, lyrics, prompt, workflow='draft')
        DB-->>API: Sketch ID
        API-->>SketchCreator: Success
        SketchCreator-->>SketchLib: Redirect to Library
    else Edit Existing Sketch
        SketchLib->>SketchCreator: Open Sketch (ID)
        SketchCreator->>API: GET /api/v1/sketches/{id}
        API->>DB: SELECT song_sketches
        DB-->>API: Sketch Data
        API-->>SketchCreator: Sketch
        User->>SketchCreator: Modify Title/Lyrics/Style
        SketchCreator->>API: PUT /api/v1/sketches/{id}
        API->>DB: UPDATE song_sketches
        API-->>SketchCreator: Success
    end

    %% Phase 2: Optional Lyric Refinement
    opt Refine Lyrics in Lyric Editor
        SketchLib->>LyricEditor: Open Lyric Editor<br/>(Pass Sketch Data)
        User->>LyricEditor: Edit Lyrics with AI Tools<br/>(Improve, Rewrite, Extend)
        LyricEditor->>API: POST /api/chat/ollama<br/>(Lyric Enhancement)
        API->>Ollama: Ollama Generation
        Ollama-->>API: Enhanced Lyrics
        API-->>LyricEditor: Updated Section
        LyricEditor->>LyricEditor: Apply to Structure
        LyricEditor->>SketchCreator: Save to Sketch (via localStorage)
        SketchCreator->>API: PUT /api/v1/sketches/{id}<br/>(Updated Lyrics)
        API->>DB: UPDATE song_sketches.lyrics
    end

    %% Phase 3: Song Generation
    SketchLib->>SongGen: Generate Song from Sketch
    SongGen->>API: GET /api/v1/sketches/{id}
    API->>DB: SELECT song_sketches
    DB-->>API: Sketch Data
    API-->>SongGen: Pre-fill Form<br/>(Title, Lyrics, Style Prompt)

    User->>SongGen: Review/Modify Settings<br/>(Instrumental, Model)
    SongGen->>API: POST /api/v1/song/generate<br/>{sketch_id, lyrics, prompt, is_instrumental}

    API->>DB: INSERT songs<br/>(sketch_id, status='PENDING')
    DB-->>API: Song ID

    API->>Celery: Queue Task<br/>(Task ID = Song ID)
    Celery->>Redis: Store Task Metadata

    API-->>SongGen: {task_id, song_id}
    SongGen-->>User: "Generation Started"

    %% Phase 4: Async Processing
    Celery->>Mureka: POST /jobs/create<br/>(Lyrics, Style, Instrumental)
    Mureka-->>Celery: {job_id}

    Celery->>DB: UPDATE songs<br/>(job_id, status='PROGRESS')
    Celery->>Redis: Update Progress (0%)

    loop Poll Mureka Status (every 30s)
        Celery->>Mureka: GET /jobs/{job_id}/status
        Mureka-->>Celery: {status, progress}
        Celery->>DB: UPDATE songs.progress_info
        Celery->>Redis: Update Progress

        opt User Polls Frontend
            User->>SongGen: Check Status
            SongGen->>API: GET /api/v1/song/{id}
            API->>DB: SELECT songs
            DB-->>API: Song Data (status, progress)
            API-->>SongGen: Progress Update
            SongGen-->>User: Show Progress (%)
        end
    end

    %% Phase 5: Completion
    Mureka-->>Celery: Generation Complete<br/>{choices: [{mp3_url, flac_url, ...}]}

    Celery->>DB: UPDATE songs<br/>(status='SUCCESS', mureka_response)
    Celery->>DB: INSERT song_choices<br/>(mp3_url, flac_url, duration, ...)

    Celery->>DB: UPDATE song_sketches<br/>(workflow='used')

    Celery->>Redis: Clear Task

    User->>SongGen: Refresh/Navigate to Song View
    SongGen->>API: GET /api/v1/song/{id}
    API->>DB: SELECT songs + song_choices
    DB-->>API: Song with Choices
    API-->>SongGen: Complete Song Data

    SongGen-->>User: Display Song<br/>(Play MP3/FLAC, Download Stems)

    Note over User,Redis: Sketch marked as 'used' after successful generation
