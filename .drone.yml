kind: pipeline
type: docker
name: default

# Trigger: Wann soll die Pipeline laufen?
trigger:
  event:
    - push
    - tag
  branch:
    - main

# Platform
platform:
  os: linux
  arch: arm64

# Build Steps
steps:

  # ─────────────────────────────────────────────────────────
  # STEP 1: Version auslesen
  # ─────────────────────────────────────────────────────────
  - name: read-version
    image: alpine:latest
    commands:
      - echo "Reading VERSION files..."
      - cat aiproxysrv/VERSION || echo "v0.0.0" > aiproxysrv/VERSION
      - cat aiwebui/VERSION || echo "v0.0.0" > aiwebui/VERSION
      - export BACKEND_VERSION=$(cat aiproxysrv/VERSION | tr -d '[:space:]')
      - export FRONTEND_VERSION=$(cat aiwebui/VERSION | tr -d '[:space:]')
      - echo "Backend Version = $BACKEND_VERSION"
      - echo "Frontend Version = $FRONTEND_VERSION"

  # ─────────────────────────────────────────────────────────
  # STEP 2: Angular Lint & Test
  # ─────────────────────────────────────────────────────────
  - name: lint-frontend
    image: node:20-slim
    commands:
      - cd aiwebui
      - npm ci --prefer-offline --no-audit
      - npm run lint
      # Optional: Tests ausführen
      # - npm run test -- --watch=false --browsers=ChromeHeadless

  # ─────────────────────────────────────────────────────────
  # STEP 3: Build aiproxysrv Docker Images
  # ─────────────────────────────────────────────────────────
  - name: build-aiproxysrv
    image: plugins/docker
    settings:
      registry: ghcr.io
      repo: ghcr.io/rwellinger/aiproxysrv-app
      username: rwellinger
      password:
        from_secret: github_token
      context: aiproxysrv
      dockerfile: aiproxysrv/dockerfile
      target: app
      auto_tag: true
      auto_tag_suffix: ""
      tags:
        - latest
        - ${DRONE_TAG}
    when:
      event:
        - tag
      ref:
        - refs/tags/v*

  # ─────────────────────────────────────────────────────────
  # STEP 4: Build celery-worker Docker Images
  # ─────────────────────────────────────────────────────────
  - name: build-celery-worker
    image: plugins/docker
    settings:
      registry: ghcr.io
      repo: ghcr.io/rwellinger/celery-worker-app
      username: rwellinger
      password:
        from_secret: github_token
      context: aiproxysrv
      dockerfile: aiproxysrv/dockerfile
      target: worker
      auto_tag: true
      auto_tag_suffix: ""
      tags:
        - latest
        - ${DRONE_TAG}
    when:
      event:
        - tag
      ref:
        - refs/tags/v*

  # ─────────────────────────────────────────────────────────
  # STEP 5: Build aiwebui Docker Image
  # ─────────────────────────────────────────────────────────
  - name: build-aiwebui
    image: plugins/docker
    settings:
      registry: ghcr.io
      repo: ghcr.io/rwellinger/aiwebui-app
      username: rwellinger
      password:
        from_secret: github_token
      context: aiwebui
      dockerfile: aiwebui/dockerfile
      target: production
      auto_tag: true
      auto_tag_suffix: ""
      tags:
        - latest
        - ${DRONE_TAG}
    when:
      event:
        - tag
      ref:
        - refs/tags/v*

  # ─────────────────────────────────────────────────────────
  # STEP 6: (Optional) Deployment
  # ─────────────────────────────────────────────────────────
  # - name: deploy-production
  #   image: appleboy/drone-ssh
  #   settings:
  #     host: 10.0.1.120
  #     username: robertw
  #     key:
  #       from_secret: ssh_key
  #     script:
  #       - cd /path/to/deployment
  #       - docker compose pull
  #       - docker compose up -d
  #   when:
  #     event:
  #       - tag
  #     ref:
  #       - refs/tags/v*

  # ─────────────────────────────────────────────────────────
  # STEP 7: Notification (Optional)
  # ─────────────────────────────────────────────────────────
  # - name: notify
  #   image: plugins/slack
  #   settings:
  #     webhook:
  #       from_secret: slack_webhook
  #     channel: ci-builds
  #     template: >
  #       Build {{build.status}} for {{repo.name}}
  #       Tag: {{build.tag}}
  #       Author: {{build.author}}
  #   when:
  #     status:
  #       - success
  #       - failure
